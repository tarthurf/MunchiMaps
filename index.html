<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MunchiMaps</title>
    <link rel="stylesheet" href="assets/styles/reset.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css">
    <link href="https://fonts.googleapis.com/css?family=Comfortaa|Fredoka+One&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/styles/style.css">
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src=script.js></script>
    <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
</head>

<body>
    <section class="hero is-small is-primary is-bold fredoka">
        <div class="hero-body">
            <div class="container">
                <h1 class="title is-1">
                    MunchiMaps
                </h1>
                <p class="subtitle">
                    Connecting CBD to Delicious food
                </p>
            </div>
        </div>
    </section>

    <section class="box is-marginless comfortaa">
        <div class="field has-addons ">
            <div class="control has-icons-left">
                <input class="input is-fluid" type="text" placeholder="City or Zip">
                <span class="icon is-small is-left">
                    <img src="assets/images/GPS-PNG-HD.png"></img>
                </span>
            </div>
            <div class="control">
                <a class="button is-primary">
                    Search
                </a>
            </div>
        </div>
        <p class="help text-is-centered">Leave Empty For Current Location</p>
    </section>


    <section class="section card-section" id="search-results">
        <div class="container">
        </div>
    </section>

    <section class="section">
        <div class="box" id="map">
        </div>
   </section>

    <footer class="footer">
        <div class="content has-text-centered">
            <p>
                <strong>Bulma</strong> by <a href="https://jgthms.com">Jeremy Thomas</a>. The source code is licensed
                <a href="http://opensource.org/licenses/mit-license.php">MIT</a>. The website content
                is licensed <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY NC SA 4.0</a>.
            </p>
        </div>
    </footer>

</body>
<!-- This script id for the Yelp API call-->
<script>
    var dispArray = [];
    var restArray = [];

    function getDispensary(userLoc) {
        var location = userLoc;
        var settings = {
            "url": "http://cors-anywhere.herokuapp.com/https://api.yelp.com/v3/businesses/search?&term=weed&location=" + location,
            "method": "GET",
            "timeout": 0,
            "headers": {
                "accept": "application/json",
                "x-requested-with": "xmlhttprequest",
                "Access-Control-Allow-Origin": "*",
                "Authorization": "Bearer f8a8rHUaTF8-rGjw6Ap5l3RLMBlUolqUUy7wKupzJ1MDPlSWDctHN4Qh197KOHHmaUEHXNA_5wljb3aJAramwCFqZPoaq7gPHRpCE9a7FLrWpwY9eaw3Mr4vw-g1XnYx"
            },
        };

        $.ajax(settings).done(function (response) {
            for (let index = 0; index < 5; index++) {
                dispArray[index] = response.businesses[index];
            }
            localStorage.setItem("dispArray", JSON.stringify(dispArray));
            var item = JSON.parse(localStorage.getItem("dispArray"));
            console.log(item);
            for (index = 0; index < item.length; index++) {
                makeCards(item[index], index);
            }
        });

    }

    function getRestaurants(dispLoc) {
        var location = dispLoc;
        var settings = {
            "url": "http://cors-anywhere.herokuapp.com/https://api.yelp.com/v3/businesses/search?&term=restaurants&location=" + location,
            "method": "GET",
            "timeout": 0,
            "headers": {
                "accept": "application/json",
                "x-requested-with": "xmlhttprequest",
                "Access-Control-Allow-Origin": "*",
                "Authorization": "Bearer f8a8rHUaTF8-rGjw6Ap5l3RLMBlUolqUUy7wKupzJ1MDPlSWDctHN4Qh197KOHHmaUEHXNA_5wljb3aJAramwCFqZPoaq7gPHRpCE9a7FLrWpwY9eaw3Mr4vw-g1XnYx"
            },
        };

        $.ajax(settings).done(function (response) {
            for (let index = 0; index < 5; index++) {
                restArray[index] = response.businesses[index];
            }
            localStorage.setItem("restArray", JSON.stringify(restArray));
        }).done(function () {
            let mapDiv = $("<div>").attr("id", "map");
            $("#map").append(mapDiv);
            initMap();  
        });
        console.log(restArray);
    }
    function makeCards(obj, index) {
        var card = $("<div>", {
            "class": "card-content",
            "value": index
        });
        var media = $("<div>", { "class": "media" });
        var col = $("<div>", { "class": "column" });
        var imgHolder = $("<div>", { "class": "card-image" });
        var fig = $("<figure>", { "class": "image is-2by1" });
        var img = $("<img>", {
            "class": "business-image",
            "src": obj.image_url,
            "alt": "Placeholder Image"
        });
        var content = $("<div>", { "class": "content comforataa" });
        var busName = $("<div>", {
            "id": "businessName",
            "text": obj.name
        });
        var busAddy = $("<div>", {
            "id": "address",
            "text": obj.location.address1
        });
        var busNum = $("<div>", {
            "id": "phoneNumber",
            "text": obj.phone
        });
        var indivCard = $("<div>", {
            "class": "card"
        });
        // "style": "margin-bottom: 12px"
        content.append(busName, busAddy, busNum);

        fig.append(img);
        imgHolder.append(fig);



        media.append(content);
        card.append(media);
        col.append(card);
        indivCard.append(imgHolder);
        indivCard.append(col);

        $(".card-section").find(".container").append(indivCard);


    }

    $(".is-primary").on("click", function () {
        $(".card").empty();
        getDispensary($(".input").val());
    });

    $(document).on("click", ".card", function () {
        $(this).find(".card-content").attr("value");
        var location = $(this).find("#businessName").text();
        getRestaurants(location);

    });

    // Google Maps Init Function
    function initMap() {
        console.log("1");
        let map;
        let bounds = new google.maps.LatLngBounds();
        let mapOptions = {
            mapTypeId: "roadmap"
        };

        // Display a map on the page
        map = new google.maps.Map(
            document.getElementById("map"),
            mapOptions
        );
        console.log("2")
        // Custom markers
        let iconBase = "assets/images/";

        let icons = {
            dispensary: {
                icon: iconBase + "marker-green.png"
            },
            restaurant: {
                icon: iconBase + "marker-restaurant.png"
            }
        };

        // Display multiple markers on a map
        let infoWindow = new google.maps.InfoWindow(),
            marker,
            i;

        // Loop through our array of markers & place each one on the map
        for (let i = 0; i < 5; i++) {
            console.log("FOR LOOP");
            let position = new google.maps.LatLng(
                restArray[i].coordinates.latitude,
                restArray[i].coordinates.longitude
            );
            bounds.extend(position);
            marker = new google.maps.Marker({
                position: position,
                map: map,
                title: restArray[0].name,
                icon: icons["restaurant"].icon
            });

            // TODO: rearrange yelp page array
            // Info Window Content
            let infoWindowContent =
                "<div>" +
                restArray[i].name +
                "</div>" +
                "<p>" +
                restArray[i].location.address1 +
                "</p>" +
                "<p>" +
                restArray[i].location.city +
                ", " +
                restArray[i].location.state +
                "</p>" +
                "<p>" +
                "Price: " +
                restArray[i].price +
                "</p>" +
                "<a href=" +
                restArray[i].url +
                ">Yelp Page</a>" +
                '<a href="https://www.google.com/maps/dir/?api=1&origin=' +
                restArray[i].location.address1 +
                "%2C+" +
                restArray[i].location.city +
                "%2C+" +
                restArray[i].location.state +
                "&destination=" +
                dispArray[0].location.address1 +
                "%2C+" +
                dispArray[0].location.city +
                "%2C+" +
                dispArray[0].location.state +
                '&travelmode=driving">Get Directions</a>';

            // how to create direction url for google maps https://developers.google.com/maps/documentation/urls/guide#directions-action

            // Allow each marker to have an info window
            google.maps.event.addListener(
                marker,
                "click",
                (function (marker, i) {
                    return function () {
                        infoWindow.setContent(infoWindowContent);
                        infoWindow.open(map, marker);
                    };
                })(marker, i)
            );

            // Automatically center the map fitting all markers on the screen
            map.fitBounds(bounds);
        }

        // Dispensary position
        let disp_Position = new google.maps.LatLng(
            dispArray[0].coordinates.latitude,
            dispArray[0].coordinates.longitude
        );
        bounds.extend(disp_Position);

        // Dispensary marker
        disp_marker = new google.maps.Marker({
            position: disp_Position,
            map: map,
            title: dispArray[0].name,
            icon: icons["dispensary"].icon
        });

        // Dispensary Info Window Content
        // let disp_InfoWindowContent =
        //     "<div>" +
        //     dispArray[0].name +
        //     "</div>" +
        //     "<p>" +
        //     dispArray[0].location.address1 +
        //     "</p>" +
        //     "<p>" +
        //     dispArray[0].location.city +
        //     ", " +
        //     dispArray[0].location.state +
        //     "</p>" +
        //     "<p>" +
        //     "Price: " +
        //     dispArray[0].price +
        //     "</p>" +
        //     "<a href=" +
        //     dispArray[0].url +
        //     "target='_blank'>Yelp Page</a>" +
        //     '<a target="_blank" href="https://www.google.com/maps/search/?api=1&query=' +
        //     restArray[i].location.address1 +
        //     "%2C+" +
        //     restArray[i].location.city +
        //     "%2C+" +
        //     restArray[i].location.state +
        //     "'>Google Maps</a>";

        // Dispensary Info Window Event Listener
        // google.maps.event.addListener(
        //     disp_marker,
        //     "click",
        //     (function (marker, i) {
        //         return function () {
        //             infoWindow.setContent(disp_InfoWindowContent);
        //             infoWindow.open(map, disp_marker);
        //         };
        //     })(marker, i)
        // );

        // Override our map zoom level once our fitBounds function runs (Make sure it only runs once). CAN POSSIBLE REMOVE
        var boundsListener = google.maps.event.addListener(
            map,
            "bounds_changed",
            function (event) {
                // this.setZoom(14);
                google.maps.event.removeListener(boundsListener);
            }
        );
    }



    //Need Ajax request to return list of 5 weed dispensaries nearby
    //store the 5 dispensaries as objects in an array 
    //Object needs to Business name, location, photo, rating, price, small description
    //Once a business is picked, use that location to bring up 5 restaurants by that location 
    //Object needs to Business name, location, photo, rating, price, small description

</script>
<!-- This script is for the Yelp API call -->

<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCQn3tVrx8y7zQ6KM9bdu6FQ78D3BLMUCk"></script>
<script>

</script>

<!-- linking scripts -->


</html>